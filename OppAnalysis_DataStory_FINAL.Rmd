---
title: 'Gasbarro Capstone Project: Data Story - FINAL VERSION'
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
date: "January 18, 2019"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
## IMPORTING THE SPREADSHEET

library(readxl)
library(tidyverse)
library(dplyr)
library(readxl)
library(stringr)
library(lubridate)
library(ggplot2)
library(xts)
library(scales)

opps_revised <- readRDS("opps_revised.rds")

opps_revised <- opps_revised %>%
  mutate(
    industry_simple = case_when(
      industry == "Aerospace & Defense" ~ "Everything Else",
      industry == "Automotive" ~ "Everything Else",
      industry == "Computer Hardware" ~ "Everything Else",
      industry == "Computer Software" ~ "Everything Else",
      industry == "Consumer Packaged Goods" ~ "Everything Else",
      industry == "Distribution & Transportation" ~ "Engineering",
      industry == "Education" ~ "Everything Else",
      industry == "Energy" ~ "Energy",
      industry == "Engineering & Construction" ~ "Engineering",
      industry == "Federal Public Sector" ~ "Public Sector",
      industry == "Financial Services" ~ "Financial",
      industry == "Healthcare" ~ "Healthcare",
      industry == "Hospitals / Health Care" ~ "Everything Else",
      industry == "Insurance" ~ "Insurance",
      industry == "Legal" ~ "Everything Else",
      industry == "Manufacturing" ~ "Everything Else",
      industry == "Media & Entertainment" ~ "Everything Else",
      industry == "Other" ~ "Everything Else",
      industry == "Pharmaceutical" ~ "Everything Else",
      industry == "Professional Services" ~ "Everything Else",
      industry == "Public Administration" ~ "Everything Else",
      industry == "Public Sector" ~ "Public Sector",
      industry == "Retail" ~ "Everything Else",
      industry == "Telecommunications" ~ "Everything Else",
      industry == "Transportation & Public Utilities" ~ "Engineering",
      industry == "Travel" ~ "Everything Else",
      industry == "Utilities" ~ "Energy",
      industry == "" ~ "Missing"
    )
  )

opps_revised2 <- opps_revised %>% 
  mutate(close_year=year(close_date), close_month=month(close_date), combo_date=paste(close_year, close_month, sep="_"))



```

# Introduction
A years ago, our company created an entire working group devoted to developing a professional expertise and sophisticated software products for customers in the Energy & Engineering sector. The decision to form this group was based on the fact that a significant number of our customers were in these business sectors, and were trying to use our software to accomplish industry-specific goals and practices.

The big question we want to know is: How are we doing? The following sections and charts answer the targeted questions that feed the big question, and should give us a good picture of how are Energy & Engineering business development is doing.

\newpage
# Basic Information

```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

opps_industry_all <- opps_revised2 %>% 
  filter(stage_simple=="WON") %>%
  group_by(industry_simple) %>%
  summarize (countWon=n(),
             sumWon=sum(expected_revenue_usd), 
             meanWon=mean(expected_revenue_usd), 
             medianWon=median(expected_revenue_usd),
             maxWon=max(expected_revenue_usd),
             minWon=min(expected_revenue_usd))

```

The following table shows a summary of the deals WON, grouped by each industry.

```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
opps_industry_all
```

If rendered into a pie chart, it shows that the Energy and Engineering industries, when grouped together, have a significant amount of deals, compared with other business sectors (like Financial, Insurance, and Healthcare)

```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
pie(opps_industry_all$countWon, labels = opps_industry_all$industry_simple, radius = 1.0)
```

\newpage
# Industry By Year
```{r, BARINDUSTRYYEAR, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
ggplot(subset(opps_revised,industry_simple %in% c("Energy" , "Utilities", "Engineering","Distribution")), aes(x = fiscal_year, fill=industry_simple)) + 
  geom_bar()
```

```{r, YEARBYINDUSTRY, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
ggplot(subset(opps_revised,industry_simple %in% c("Energy" , "Utilities", "Engineering","Distribution")), aes(x = industry_simple, fill=fiscal_year)) + 
  geom_bar()

```
\newpage
# Expected Revenue by Industry

The following chart appears to show the following for each Industry:
- black line is the MEDIAN
- top is 75th percentile
- bottom is 25th percentile
- the "whiskers" represent the additional range of values
- the dots represent the outliers

The graph seems to show that the Energy industry ranges are in alignment with the median and distributions for other industries.

```{r, BOXPLOT, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

# Filter on WON opportunities, Group by INDUSTRY
opps_revised2 %>% 
  filter(stage_simple=="WON") %>%
  group_by(industry_simple) %>%
  summarize (sumWon=sum(expected_revenue_usd), 
             meanWon=mean(expected_revenue_usd), 
             medianWon=median(expected_revenue_usd),
             maxWon=max(expected_revenue_usd),
             minWon=min(expected_revenue_usd))

ggplot(opps_revised2, aes(x = industry_simple, y = expected_revenue_usd)) +
  geom_boxplot() +
  scale_y_log10() +
  ggtitle("Expected Revenue By Industry")
```

\newpage
# Faceted Display of Industries by Year and Total Amounts

```{r, FACETDISPLAY, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
ggplot(subset(opps_revised,industry_simple %in% c("Energy" , "Utilities", "Engineering","Distribution","Everything Else")), aes(x = close_date, y = forecasted_amount_usd, col=stage_simple)) +
  geom_point(alpha=0.2) +
  scale_y_continuous(limits = c(100000,500000)) +
  geom_jitter() +
  facet_grid(. ~ industry_simple)

ggplot(subset(opps_revised,industry_simple %in% c("Energy" , "Utilities", "Engineering","Distribution")), aes(x = close_date, y = forecasted_amount_usd, col=industry_simple)) +
  geom_point(alpha=0.2) +
  scale_y_continuous(limits = c(100000,500000)) +
  geom_jitter() +
  facet_grid(. ~ stage_simple)

```


\newpage
# Grouped By Years and Months

```{r, GROUPYEARMONTH, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

opps_revised2 <- opps_revised %>% 
  mutate(close_year=year(close_date), close_month=month(close_date), combo_date=paste(close_year, close_month, sep="_"), combo_qtr=quarter(close_date, with_year=TRUE))

opps_combo_qtr <- opps_revised2 %>% 
  filter(stage_simple=="WON") %>%
  group_by(combo_qtr, industry_simple) %>%
  summarize (sumWon=sum(expected_revenue_usd), 
             meanWon=mean(expected_revenue_usd), 
             medianWon=median(expected_revenue_usd),
             maxWon=max(expected_revenue_usd),
             minWon=min(expected_revenue_usd)) %>%
  ungroup()

ggplot(opps_combo_qtr, aes(x = combo_qtr, y = sumWon, color=industry_simple)) +
  geom_point() +
  expand_limits(y = 0) +
  ggtitle("Sum Amounts of WON by Fiscal Quarter 2016-2018")

ggplot(opps_combo_qtr, aes(x = combo_qtr, y = sumWon, color=industry_simple)) +
  geom_line() +
  expand_limits(y = 0) +
  ggtitle("Sum Amounts of WON by Fiscal Quarter 2016-2018")
  
ggplot(opps_combo_qtr, aes(x = combo_qtr, y = meanWon, color=industry_simple)) +
  geom_line() +
  expand_limits(y = 0) +
  ggtitle("Mean Amounts of WON by Fiscal Quarter 2016-2018")

ggplot(opps_combo_qtr, aes(x = combo_qtr, y = medianWon, color=industry_simple)) +
  geom_line() +
  expand_limits(y = 0) +
  ggtitle("Median Amounts of WON by Fiscal Quarter 2016-2018")

```


```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

```
